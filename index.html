<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .top-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1001;
        }
        .chain-select {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            min-width: 120px;
        }
        .wallet-connect-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .wallet-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .wallet-connect-btn.connected {
            background: linear-gradient(135deg, #718096, #4a5568);
        }
        .disconnect-btn {
            padding: 6px 10px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 8px;
        }
        .disconnect-btn:hover {
            background: #c53030;
        }
        .wallet-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            display: none;
            z-index: 1002;
        }
        .wallet-dropdown.show { display: block; }
        .wallet-option {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #f1f5f9;
        }
        .wallet-option:hover { background-color: #f8fafc; }
        .wallet-option:last-child { border-bottom: none; }
        .wallet-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #718096, #4a5568);
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #333; font-size: 2rem; margin-bottom: 8px; }
        .header p { color: #666; font-size: 1rem; }
        .section-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        .deposit-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }
        .deposit-form { display: none; }
        .deposit-form.active { display: block; }
        .form-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .form-group { margin-bottom: 15px; flex: 1; }
        .form-group.token-group { flex: 0 0 130px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4a5568;
        }
        .token-balance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
            margin-top: -10px;
            margin-bottom: 15px;
        }
        .max-btn {
            background: #e2e8f0;
            border: none;
            padding: 4px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            color: #2d3748;
            display: none;
        }
        .max-btn:hover { background: #cbd5e0; }
        .deposit-info {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            margin: 12px 0;
        }
        .deposit-address {
            font-family: monospace;
            background: white;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #cbd5e1;
            word-break: break-all;
            font-size: 0.85rem;
        }
        .network-info {
            background: #e2e8f0;
            border: 1px solid #718096;
            border-radius: 8px;
            padding: 8px;
            margin: 8px 0;
            text-align: center;
            color: #1a202c;
            font-weight: 600;
            font-size: 0.85rem;
            display: none;
        }
        .deposit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .deposit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .deposit-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            text-align: center;
            font-weight: 600;
            display: none;
            font-size: 0.9rem;
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #e0e7ff; color: #3730a3; }
        .transaction-log {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        .transaction-log h4 { font-size: 0.9rem; margin-bottom: 8px; }
        .transaction-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.85rem;
        }
        .tx-hash {
            font-family: monospace;
            color: #4a5568;
            word-break: break-all;
            cursor: pointer;
            text-decoration: underline;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a5568;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .deposit-totals-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        .deposit-totals-container h3 {
            font-size: 1rem;
            color: #2d3748;
            margin-bottom: 15px;
        }
        .totals-summary {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        .total-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
        }
        .total-count {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 8px;
        }
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab:hover {
            color: #4a5568;
        }
        .tab.active {
            color: #2d3748;
            border-bottom-color: #2d3748;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .withdraw-form {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
        }
        .auth-status {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        .auth-status.verified {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }
        .auth-btn {
            width: 100%;
            padding: 10px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .auth-btn:hover {
            background: #d97706;
        }
        .auth-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .withdraw-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .withdraw-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.3);
        }
        .withdraw-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .withdraw-requests {
            margin-top: 20px;
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
        }
        .withdraw-requests h4 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #4a5568;
        }
        .request-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .request-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .request-status.pending {
            background: #fef3c7;
            color: #92400e;
        }
        .request-status.approved {
            background: #d1fae5;
            color: #065f46;
        }
        .request-status.rejected {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="top-controls">
        <select class="chain-select" id="topChainSelect">
            <option value="">Select Chain</option>
            <option value="ethereum">Ethereum</option>
            <option value="arbitrum">Arbitrum</option>
            <option value="base">Base</option>
            <option value="solana">Solana</option>
        </select>
        <div style="position: relative; display: flex; align-items: center;">
            <button class="wallet-connect-btn" id="walletConnectBtn">
                <span id="walletConnectText">Connect Wallet</span>
                <span id="walletConnectIcon">‚ö°</span>
            </button>
            <button class="disconnect-btn" id="disconnectBtn" style="display: none;">‚úï</button>
            <div class="wallet-dropdown" id="walletDropdown">
                <div class="wallet-option" id="connectMetaMask">
                    <div class="wallet-icon"></div>
                    <span>MetaMask</span>
                </div>
                <div class="wallet-option" id="connectPhantom">
                    <div class="wallet-icon"></div>
                    <span>Phantom</span>
                </div>
                <div class="wallet-option" id="connectRabby">
                    <div class="wallet-icon"></div>
                    <span>Rabby</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Crypto Platform</h1>
            <p>Deposit & Withdraw USDC & USDT Securely</p>
        </div>

        <div class="tabs">
            <button class="tab active" id="depositTab">Deposit</button>
            <button class="tab" id="withdrawTab">Withdraw</button>
        </div>

        <!-- DEPOSIT TAB -->
        <div class="tab-content active" id="depositContent">
            <div class="deposit-section" style="border-top: none; padding-top: 0;">
                <div id="depositForm" class="deposit-form">
                    <div class="form-row">
                        <div class="form-group token-group">
                            <label for="tokenSelect">Token:</label>
                            <select id="tokenSelect">
                                <option value="">Select...</option>
                                <option value="USDC">USDC</option>
                                <option value="USDT">USDT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">Amount:</label>
                            <input type="number" id="amount" placeholder="0.0" step="0.000001" min="0">
                        </div>
                    </div>

                    <div class="token-balance">
                        <span id="tokenBalanceDisplay">Balance: --</span>
                        <button class="max-btn" id="maxBtn">MAX</button>
                    </div>

                    <div class="deposit-info">
                        <p style="margin-bottom: 5px; font-size: 0.9rem;"><strong>Deposit Address:</strong></p>
                        <p id="depositAddress" class="deposit-address">Select a chain to see deposit address</p>
                        <div class="network-info" id="networkInfo">
                            <span id="networkInfoText"></span>
                        </div>
                    </div>

                    <button class="deposit-btn" id="depositBtn" disabled>Deposit Tokens</button>
                </div>
            </div>
        </div>

        <!-- WITHDRAW TAB -->
        <div class="tab-content" id="withdrawContent">
            <div class="withdraw-form">
                <div class="auth-status" id="authStatus">
                    üîê Please verify wallet ownership to request withdrawals
                </div>
                
                <button class="auth-btn" id="authBtn">Sign Message to Verify Wallet</button>

                <div id="withdrawFormFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group token-group">
                            <label for="withdrawToken">Token:</label>
                            <select id="withdrawToken">
                                <option value="">Select...</option>
                                <option value="USDC">USDC</option>
                                <option value="USDT">USDT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="withdrawAmount">Amount:</label>
                            <input type="number" id="withdrawAmount" placeholder="0.0" step="0.000001" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="withdrawAddress">Withdraw to Address:</label>
                        <input type="text" id="withdrawAddress" placeholder="0x... or Solana address">
                    </div>

                    <div class="form-group">
                        <label for="withdrawNetwork">Network:</label>
                        <select id="withdrawNetwork">
                            <option value="">Select network...</option>
                            <option value="ethereum">Ethereum</option>
                            <option value="arbitrum">Arbitrum</option>
                            <option value="base">Base</option>
                            <option value="solana">Solana</option>
                        </select>
                    </div>

                    <button class="withdraw-btn" id="withdrawBtn" disabled>Request Withdrawal</button>
                </div>

                <div class="withdraw-requests" id="withdrawRequests" style="display: none;">
                    <h4>üìã Your Withdrawal Requests</h4>
                    <div id="requestsList"></div>
                </div>
            </div>
        </div>

        <div class="transaction-log" id="transactionLog">
            <h4>Transaction History</h4>
            <div id="transactionList"></div>
        </div>

        <div class="deposit-totals-container" id="depositTotalsContainer">
            <h3>üìä Your Deposit Summary</h3>
            <div id="depositTotals"></div>
        </div>

        <div id="status" class="status"></div>
    </div>

    <script>
        // State
        let currentWallet = null;
        let currentProvider = null;
        let currentAddress = null;
        let currentChainId = null;
        let transactionHistory = [];
        let currentTokenBalance = 0;
        let isWalletVerified = false;
        let verificationSignature = null;

        // Config
        const DEPOSIT_ADDRESSES = {
            ethereum: '0x0648B7CBb8C4424f6fAa17714d415106b12396eE',
            arbitrum: '0x0648B7CBb8C4424f6fAa17714d415106b12396eE',
            base: '0x0648B7CBb8C4424f6fAa17714d415106b12396eE',
            solana: 'xEPGhfFzud5jKJrMmvzqwLhgMqz3KTjoJ3bPQB6mtKr'
        };

        const TOKEN_CONTRACTS = {
            ethereum: {
                USDC: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                USDT: '0xdAC17F958D2ee523a2206206994597C13D831ec7'
            },
            arbitrum: {
                USDC: '0xaf88d065e77c8cc2239327c5edb3a432268e5831',
                USDT: '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9'
            },
            base: {
                USDC: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
                USDT: '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb'
            }
        };

        const NETWORKS = {
            ethereum: { chainId: '0x1', chainName: 'Ethereum Mainnet', blockExplorer: 'https://etherscan.io' },
            arbitrum: { chainId: '0xa4b1', chainName: 'Arbitrum One', blockExplorer: 'https://arbiscan.io' },
            base: { chainId: '0x2105', chainName: 'Base', blockExplorer: 'https://basescan.org' },
            solana: { chainName: 'Solana Mainnet', blockExplorer: 'https://solscan.io' }
        };

        // Supabase
        const SUPABASE_URL = 'https://ltgaocmbllnsmufsqvbt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SSII0h2vpbphbiX_4HkN5A_Evej7mbJ';

        // DOM Elements
        const topChainSelect = document.getElementById('topChainSelect');
        const walletConnectBtn = document.getElementById('walletConnectBtn');
        const walletConnectText = document.getElementById('walletConnectText');
        const walletConnectIcon = document.getElementById('walletConnectIcon');
        const walletDropdown = document.getElementById('walletDropdown');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const depositForm = document.getElementById('depositForm');
        const depositAddress = document.getElementById('depositAddress');
        const networkInfo = document.getElementById('networkInfo');
        const networkInfoText = document.getElementById('networkInfoText');
        const tokenSelect = document.getElementById('tokenSelect');
        const amountInput = document.getElementById('amount');
        const depositBtn = document.getElementById('depositBtn');
        const tokenBalanceDisplay = document.getElementById('tokenBalanceDisplay');
        const maxBtn = document.getElementById('maxBtn');
        const statusEl = document.getElementById('status');
        const transactionLog = document.getElementById('transactionLog');
        const transactionList = document.getElementById('transactionList');
        const depositTotalsContainer = document.getElementById('depositTotalsContainer');
        const depositTotals = document.getElementById('depositTotals');
        
        // Tab elements
        const depositTab = document.getElementById('depositTab');
        const withdrawTab = document.getElementById('withdrawTab');
        const depositContent = document.getElementById('depositContent');
        const withdrawContent = document.getElementById('withdrawContent');
        
        // Withdraw elements
        const authStatus = document.getElementById('authStatus');
        const authBtn = document.getElementById('authBtn');
        const withdrawFormFields = document.getElementById('withdrawFormFields');
        const withdrawToken = document.getElementById('withdrawToken');
        const withdrawAmount = document.getElementById('withdrawAmount');
        const withdrawAddress = document.getElementById('withdrawAddress');
        const withdrawNetwork = document.getElementById('withdrawNetwork');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const withdrawRequests = document.getElementById('withdrawRequests');
        const requestsList = document.getElementById('requestsList');

        // Helpers
        function showStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
            statusEl.style.display = 'block';
            if (type !== 'error') {
                setTimeout(() => statusEl.style.display = 'none', 8000);
            }
        }

        function abbreviateAddress(addr) {
            return addr.slice(0, 6) + '...' + addr.slice(-4);
        }

        // Chain select handler
        topChainSelect.addEventListener('change', function() {
            const chain = this.value;
            if (chain && DEPOSIT_ADDRESSES[chain]) {
                depositAddress.textContent = DEPOSIT_ADDRESSES[chain];
                depositForm.classList.add('active');
                networkInfo.style.display = 'block';
                networkInfoText.textContent = 'Network: ' + NETWORKS[chain].chainName;
            } else {
                depositAddress.textContent = 'Select a chain to see deposit address';
                depositForm.classList.remove('active');
                networkInfo.style.display = 'none';
            }
            updateDepositButton();
            if (currentAddress) checkTokenBalance();
        });

        // Wallet dropdown toggle
        walletConnectBtn.addEventListener('click', function() {
            walletDropdown.classList.toggle('show');
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.top-controls')) {
                walletDropdown.classList.remove('show');
            }
        });

        // Connect MetaMask
        document.getElementById('connectMetaMask').addEventListener('click', async function() {
            try {
                let provider = null;
                
                // Check if MetaMask is available
                if (window.ethereum?.providers) {
                    // Multiple providers - find MetaMask
                    provider = window.ethereum.providers.find(p => p.isMetaMask && !p.isPhantom);
                } else if (window.ethereum?.isMetaMask && !window.ethereum?.isPhantom) {
                    provider = window.ethereum;
                }
                
                if (!provider) {
                    throw new Error('MetaMask not found. Please install MetaMask.');
                }
                
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) throw new Error('No accounts found');
                
                currentWallet = 'MetaMask';
                currentProvider = provider;
                currentAddress = accounts[0];
                
                updateWalletUI();
                showStatus('Connected to MetaMask!', 'success');
                
                provider.on('accountsChanged', handleAccountChange);
                provider.on('chainChanged', () => location.reload());
            } catch (err) {
                showStatus('MetaMask error: ' + err.message, 'error');
            }
        });

        // Connect Phantom (Solana only)
        document.getElementById('connectPhantom').addEventListener('click', async function() {
            try {
                const phantom = window.phantom?.solana || window.solana;
                
                if (!phantom || !phantom.isPhantom) {
                    throw new Error('Phantom not found. Please install Phantom.');
                }
                
                const response = await phantom.connect();
                
                currentWallet = 'Phantom';
                currentProvider = phantom;
                currentAddress = response.publicKey.toString();
                
                topChainSelect.value = 'solana';
                topChainSelect.dispatchEvent(new Event('change'));
                
                updateWalletUI();
                showStatus('Connected to Phantom!', 'success');
            } catch (err) {
                showStatus('Phantom error: ' + err.message, 'error');
            }
        });

        // Connect Rabby
        document.getElementById('connectRabby').addEventListener('click', async function() {
            try {
                let provider = null;
                
                // Check if Rabby is available
                if (window.ethereum?.providers) {
                    // Multiple providers - find Rabby
                    provider = window.ethereum.providers.find(p => p.isRabby);
                } else if (window.ethereum?.isRabby) {
                    provider = window.ethereum;
                }
                
                if (!provider) {
                    throw new Error('Rabby not found. Please install Rabby.');
                }
                
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) throw new Error('No accounts found');
                
                currentWallet = 'Rabby';
                currentProvider = provider;
                currentAddress = accounts[0];
                
                updateWalletUI();
                showStatus('Connected to Rabby!', 'success');
                
                provider.on('accountsChanged', handleAccountChange);
                provider.on('chainChanged', () => location.reload());
            } catch (err) {
                showStatus('Rabby error: ' + err.message, 'error');
            }
        });

        function handleAccountChange(accounts) {
            if (accounts.length === 0) {
                location.reload();
            } else {
                currentAddress = accounts[0];
                updateWalletUI();
            }
        }

        function updateWalletUI() {
            walletConnectBtn.classList.add('connected');
            walletConnectText.textContent = currentWallet + ': ' + abbreviateAddress(currentAddress);
            walletConnectIcon.textContent = '‚úì';
            walletDropdown.classList.remove('show');
            disconnectBtn.style.display = 'inline-block';
            updateDepositButton();
            checkTokenBalance();
            loadDepositTotals();
            checkVerification();
        }

        // Token balance
        async function checkTokenBalance() {
            if (!currentProvider || !currentAddress) return;
            
            const network = topChainSelect.value;
            const token = tokenSelect.value;
            
            if (!network || !token || network === 'solana') {
                tokenBalanceDisplay.textContent = 'Balance: --';
                maxBtn.style.display = 'none';
                return;
            }
            
            try {
                const tokenAddress = TOKEN_CONTRACTS[network][token];
                if (!tokenAddress) return;
                
                const balanceData = '0x70a08231' + currentAddress.slice(2).padStart(64, '0');
                const balance = await currentProvider.request({
                    method: 'eth_call',
                    params: [{ to: tokenAddress, data: balanceData }, 'latest']
                });
                
                const tokenAmount = parseInt(balance, 16) / 1e6;
                currentTokenBalance = tokenAmount;
                tokenBalanceDisplay.textContent = 'Balance: ' + tokenAmount.toFixed(2) + ' ' + token;
                maxBtn.style.display = tokenAmount > 0 ? 'inline-block' : 'none';
            } catch (err) {
                tokenBalanceDisplay.textContent = 'Balance: Error';
            }
        }

        tokenSelect.addEventListener('change', function() {
            updateDepositButton();
            checkTokenBalance();
        });

        amountInput.addEventListener('input', updateDepositButton);

        maxBtn.addEventListener('click', function() {
            amountInput.value = currentTokenBalance;
            updateDepositButton();
        });

        function updateDepositButton() {
            const valid = currentWallet && topChainSelect.value && tokenSelect.value && amountInput.value && parseFloat(amountInput.value) > 0;
            depositBtn.disabled = !valid;
        }

        // Deposit
        depositBtn.addEventListener('click', async function() {
            const network = topChainSelect.value;
            const token = tokenSelect.value;
            const amount = parseFloat(amountInput.value);
            const recipient = DEPOSIT_ADDRESSES[network];

            if (!network || !token || !amount) return;

            depositBtn.disabled = true;
            depositBtn.innerHTML = '<div class="loading"></div> Processing...';

            try {
                if (network === 'solana') {
                    throw new Error('Solana deposits require additional setup');
                }

                if (currentWallet === 'Phantom') {
                    throw new Error('Use MetaMask or Rabby for EVM chains');
                }

                // Switch network if needed
                const targetChainId = NETWORKS[network].chainId;
                try {
                    await currentProvider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: targetChainId }]
                    });
                } catch (switchErr) {
                    if (switchErr.code === 4902) {
                        throw new Error('Please add ' + NETWORKS[network].chainName + ' to your wallet');
                    }
                }

                // Build ERC20 transfer
                const tokenAddress = TOKEN_CONTRACTS[network][token];
                const methodId = '0xa9059cbb';
                const paddedAddress = recipient.slice(2).toLowerCase().padStart(64, '0');
                const amountInUnits = Math.floor(amount * 1e6);
                const paddedAmount = amountInUnits.toString(16).padStart(64, '0');
                const data = methodId + paddedAddress + paddedAmount;

                const txParams = {
                    to: tokenAddress,
                    from: currentAddress,
                    data: data,
                    value: '0x0'
                };

                // Estimate gas
                try {
                    const gas = await currentProvider.request({ method: 'eth_estimateGas', params: [txParams] });
                    txParams.gas = gas;
                } catch (e) {
                    txParams.gas = '0x249F0';
                }

                // Send transaction
                const txHash = await currentProvider.request({
                    method: 'eth_sendTransaction',
                    params: [txParams]
                });

                // Log transaction
                const txData = {
                    type: 'Deposit',
                    hash: txHash,
                    amount: amount,
                    token: token,
                    network: network,
                    status: 'Pending',
                    timestamp: Date.now()
                };
                transactionHistory.unshift(txData);
                updateTransactionLog();
                transactionLog.style.display = 'block';

                showStatus('Transaction submitted: ' + txHash.slice(0, 20) + '...', 'success');
                amountInput.value = '';
                updateDepositButton();

                // Monitor transaction
                monitorTransaction(txHash, network, txData);

            } catch (err) {
                if (err.code === 4001) {
                    showStatus('Transaction cancelled', 'error');
                } else {
                    showStatus('Error: ' + err.message, 'error');
                }
            } finally {
                depositBtn.innerHTML = 'Deposit Tokens';
                depositBtn.disabled = false;
                updateDepositButton();
            }
        });

        function updateTransactionLog() {
            transactionList.innerHTML = transactionHistory.slice(0, 10).map(tx => 
                '<div class="transaction-item">' +
                '<div><strong>' + tx.type + ':</strong> ' + tx.amount + ' ' + tx.token + ' on ' + tx.network + '</div>' +
                '<div><strong>Status:</strong> ' + tx.status + '</div>' +
                '<div><strong>TX:</strong> <span class="tx-hash" onclick="window.open(\'' + NETWORKS[tx.network].blockExplorer + '/tx/' + tx.hash + '\')">' + tx.hash.slice(0, 20) + '...</span></div>' +
                '</div>'
            ).join('');
        }

        async function monitorTransaction(txHash, network, txData) {
            let attempts = 0;
            const check = async () => {
                try {
                    const receipt = await currentProvider.request({
                        method: 'eth_getTransactionReceipt',
                        params: [txHash]
                    });
                    if (receipt) {
                        txData.status = receipt.status === '0x1' ? 'Success' : 'Failed';
                        updateTransactionLog();
                        if (txData.status === 'Success') {
                            showStatus('Transaction confirmed!', 'success');
                            saveDeposit(txData.amount, txData.token, txData.network, txData.hash);
                            setTimeout(checkTokenBalance, 2000);
                        }
                        return;
                    }
                    if (++attempts < 60) setTimeout(check, 5000);
                } catch (e) {}
            };
            setTimeout(check, 5000);
        }

        // Disconnect wallet
        disconnectBtn.addEventListener('click', function() {
            currentWallet = null;
            currentProvider = null;
            currentAddress = null;
            currentChainId = null;
            isWalletVerified = false;
            verificationSignature = null;
            
            walletConnectBtn.classList.remove('connected');
            walletConnectText.textContent = 'Connect Wallet';
            walletConnectIcon.textContent = '‚ö°';
            disconnectBtn.style.display = 'none';
            
            depositForm.classList.remove('active');
            tokenBalanceDisplay.textContent = 'Balance: --';
            maxBtn.style.display = 'none';
            depositTotalsContainer.style.display = 'none';
            
            // Reset withdraw section
            authStatus.className = 'auth-status';
            authStatus.innerHTML = 'üîê Please verify wallet ownership to request withdrawals';
            authBtn.style.display = 'block';
            authBtn.disabled = false;
            withdrawFormFields.style.display = 'none';
            withdrawRequests.style.display = 'none';
            
            showStatus('Wallet disconnected', 'info');
        });

        // Tab switching
        depositTab.addEventListener('click', function() {
            depositTab.classList.add('active');
            withdrawTab.classList.remove('active');
            depositContent.classList.add('active');
            withdrawContent.classList.remove('active');
        });

        withdrawTab.addEventListener('click', function() {
            withdrawTab.classList.add('active');
            depositTab.classList.remove('active');
            withdrawContent.classList.add('active');
            depositContent.classList.remove('active');
            
            if (!currentAddress) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }
            
            loadWithdrawRequests();
        });

        // Wallet authentication - sign message to prove ownership
        authBtn.addEventListener('click', async function() {
            if (!currentAddress || !currentProvider) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            const timestamp = Date.now();
            const message = `Verify wallet ownership for Crypto Platform\n\nWallet: ${currentAddress}\nTimestamp: ${timestamp}\n\nSign this message to prove you own this wallet and enable withdrawal requests.`;

            authBtn.disabled = true;
            authBtn.textContent = 'Please sign in wallet...';

            try {
                let signature;
                
                if (currentWallet === 'Phantom') {
                    // Solana signing
                    const encodedMessage = new TextEncoder().encode(message);
                    const signedMessage = await currentProvider.signMessage(encodedMessage, 'utf8');
                    signature = btoa(String.fromCharCode(...signedMessage.signature));
                } else {
                    // EVM signing
                    signature = await currentProvider.request({
                        method: 'personal_sign',
                        params: [message, currentAddress]
                    });
                }

                verificationSignature = signature;
                isWalletVerified = true;

                // Save verification to Supabase
                await saveVerification(currentAddress, signature, timestamp);

                authStatus.className = 'auth-status verified';
                authStatus.innerHTML = '‚úÖ Wallet verified! You can now request withdrawals.';
                authBtn.style.display = 'none';
                withdrawFormFields.style.display = 'block';

                showStatus('Wallet verified successfully!', 'success');
                loadWithdrawRequests();

            } catch (err) {
                if (err.code === 4001) {
                    showStatus('Signature rejected', 'error');
                } else {
                    showStatus('Verification failed: ' + err.message, 'error');
                }
                authBtn.disabled = false;
                authBtn.textContent = 'Sign Message to Verify Wallet';
            }
        });

        // Save verification to Supabase
        async function saveVerification(wallet, signature, timestamp) {
            try {
                await fetch(SUPABASE_URL + '/rest/v1/wallet_verifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify({
                        wallet_address: wallet.toLowerCase(),
                        signature: signature,
                        verified_at: new Date(timestamp).toISOString()
                    })
                });
            } catch (e) {
                console.log('Verification save error:', e);
            }
        }

        // Check if wallet is already verified
        async function checkVerification() {
            if (!currentAddress) return;
            
            try {
                const response = await fetch(
                    SUPABASE_URL + '/rest/v1/wallet_verifications?wallet_address=eq.' + currentAddress.toLowerCase(),
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + SUPABASE_KEY
                        }
                    }
                );
                const data = await response.json();
                
                if (data && data.length > 0) {
                    isWalletVerified = true;
                    verificationSignature = data[0].signature;
                    
                    authStatus.className = 'auth-status verified';
                    authStatus.innerHTML = '‚úÖ Wallet verified! You can now request withdrawals.';
                    authBtn.style.display = 'none';
                    withdrawFormFields.style.display = 'block';
                    
                    loadWithdrawRequests();
                }
            } catch (e) {
                console.log('Verification check error:', e);
            }
        }

        // Update withdraw button state
        function updateWithdrawButton() {
            const valid = isWalletVerified && 
                         withdrawToken.value && 
                         withdrawAmount.value && 
                         parseFloat(withdrawAmount.value) > 0 &&
                         withdrawAddress.value &&
                         withdrawNetwork.value;
            withdrawBtn.disabled = !valid;
        }

        withdrawToken.addEventListener('change', updateWithdrawButton);
        withdrawAmount.addEventListener('input', updateWithdrawButton);
        withdrawAddress.addEventListener('input', updateWithdrawButton);
        withdrawNetwork.addEventListener('change', updateWithdrawButton);

        // Submit withdrawal request
        withdrawBtn.addEventListener('click', async function() {
            if (!isWalletVerified) {
                showStatus('Please verify your wallet first', 'error');
                return;
            }

            const token = withdrawToken.value;
            const amount = parseFloat(withdrawAmount.value);
            const toAddress = withdrawAddress.value.trim();
            const network = withdrawNetwork.value;

            if (!token || !amount || !toAddress || !network) {
                showStatus('Please fill all fields', 'error');
                return;
            }

            withdrawBtn.disabled = true;
            withdrawBtn.innerHTML = '<div class="loading"></div> Submitting...';

            try {
                const response = await fetch(SUPABASE_URL + '/rest/v1/withdrawal_requests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY
                    },
                    body: JSON.stringify({
                        wallet_address: currentAddress.toLowerCase(),
                        token: token,
                        amount: amount,
                        to_address: toAddress.toLowerCase(),
                        network: network,
                        status: 'pending',
                        verification_signature: verificationSignature
                    })
                });

                if (response.ok) {
                    showStatus('Withdrawal request submitted successfully!', 'success');
                    
                    // Clear form
                    withdrawToken.value = '';
                    withdrawAmount.value = '';
                    withdrawAddress.value = '';
                    withdrawNetwork.value = '';
                    
                    loadWithdrawRequests();
                } else {
                    throw new Error('Failed to submit request');
                }
            } catch (err) {
                showStatus('Error: ' + err.message, 'error');
            } finally {
                withdrawBtn.innerHTML = 'Request Withdrawal';
                updateWithdrawButton();
            }
        });

        // Load withdrawal requests
        async function loadWithdrawRequests() {
            if (!currentAddress) return;

            try {
                const response = await fetch(
                    SUPABASE_URL + '/rest/v1/withdrawal_requests?wallet_address=eq.' + currentAddress.toLowerCase() + '&order=created_at.desc',
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + SUPABASE_KEY
                        }
                    }
                );
                const data = await response.json();

                if (data && data.length > 0) {
                    withdrawRequests.style.display = 'block';
                    requestsList.innerHTML = data.map(req => 
                        '<div class="request-item">' +
                        '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                        '<strong>' + req.amount + ' ' + req.token + '</strong>' +
                        '<span class="request-status ' + req.status + '">' + req.status.toUpperCase() + '</span>' +
                        '</div>' +
                        '<div style="font-size:0.8rem;color:#666;margin-top:5px;">' +
                        'To: ' + req.to_address.slice(0, 10) + '...' + req.to_address.slice(-6) + ' (' + req.network + ')' +
                        '</div>' +
                        '<div style="font-size:0.75rem;color:#999;margin-top:3px;">' +
                        new Date(req.created_at).toLocaleString() +
                        '</div>' +
                        '</div>'
                    ).join('');
                } else {
                    withdrawRequests.style.display = 'none';
                }
            } catch (e) {
                console.log('Load requests error:', e);
            }
        }

        // Deposit tracking with Supabase
        async function saveDeposit(amount, token, network, txHash) {
            try {
                const response = await fetch(SUPABASE_URL + '/rest/v1/deposits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY
                    },
                    body: JSON.stringify({
                        wallet_address: currentAddress.toLowerCase(),
                        amount: amount,
                        token: token,
                        network: network,
                        tx_hash: txHash,
                        status: 'confirmed'
                    })
                });
                if (response.ok) {
                    loadDepositTotals();
                }
            } catch (e) {
                console.log('Supabase save error:', e);
            }
        }

        async function loadDepositTotals() {
            if (!currentAddress) return;
            try {
                const response = await fetch(
                    SUPABASE_URL + '/rest/v1/deposits?wallet_address=eq.' + currentAddress.toLowerCase() + '&status=eq.confirmed',
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + SUPABASE_KEY
                        }
                    }
                );
                const data = await response.json();
                if (data && data.length > 0) {
                    let total = 0;
                    let usdc = 0;
                    let usdt = 0;
                    data.forEach(d => {
                        total += parseFloat(d.amount);
                        if (d.token === 'USDC') usdc += parseFloat(d.amount);
                        if (d.token === 'USDT') usdt += parseFloat(d.amount);
                    });
                    depositTotalsContainer.style.display = 'block';
                    depositTotals.innerHTML = 
                        '<div class="totals-summary">' +
                        '<div class="total-value">$' + total.toFixed(2) + '</div>' +
                        '<div class="total-count">' + data.length + ' deposit(s)</div>' +
                        '<div style="margin-top:10px;font-size:0.85rem;color:#666;">USDC: $' + usdc.toFixed(2) + ' | USDT: $' + usdt.toFixed(2) + '</div>' +
                        '</div>';
                }
            } catch (e) {
                console.log('Supabase load error:', e);
            }
        }

        // Init
        showStatus('Connect your wallet to start depositing!', 'info');
    </script>
</body>
</html>


